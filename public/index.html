<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GossipChat</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-900 text-white h-screen flex flex-col">

  <header class="bg-gray-800 p-4 text-center text-xl font-bold">
    GossipChat
  </header>

  <!-- Login Form -->
  <section id="loginSection" class="flex-1 flex items-center justify-center">
    <form id="loginForm" class="bg-gray-800 p-6 rounded space-y-4">
      <input id="name" type="text" placeholder="Name" class="w-full p-2 rounded bg-gray-700 border border-gray-600" required>
      <input id="age" type="number" placeholder="Age" class="w-full p-2 rounded bg-gray-700 border border-gray-600" required>
      <input id="gender" type="text" placeholder="Gender" class="w-full p-2 rounded bg-gray-700 border border-gray-600" required>
      <button type="submit" class="w-full bg-blue-600 p-2 rounded hover:bg-blue-700">Enter Chat</button>
    </form>
  </section>

  <!-- Chat UI -->
  <main id="chatUI" class="flex flex-1 overflow-hidden hidden">
    <aside class="w-64 bg-gray-800 p-4 overflow-y-auto">
      <h2 class="text-lg font-semibold mb-4">Users</h2>
      <ul id="userList" class="space-y-2"></ul>
    </aside>

    <section class="flex-1 flex flex-col p-4">
      <div id="chatHeader" class="font-semibold text-lg mb-2">Select a user to chat</div>
      <div id="chatBox" class="flex-1 bg-gray-700 rounded p-3 overflow-y-auto mb-4"></div>
      <div class="flex space-x-2">
        <input id="messageInput" type="text" placeholder="Type a message" class="flex-1 p-2 rounded bg-gray-800 text-white border border-gray-600" />
        <button id="sendBtn" class="bg-blue-600 px-4 py-2 rounded hover:bg-blue-700">Send</button>
      </div>
    </section>
  </main>

  <script>
    const socket = io();

    let currentUserInfo = {};
    let activeUser = null;
    const messageStore = {};
    let users = [];

    const loginForm = document.getElementById('loginForm');
    const loginSection = document.getElementById('loginSection');
    const chatUI = document.getElementById('chatUI');
    const userList = document.getElementById('userList');
    const chatBox = document.getElementById('chatBox');
    const chatHeader = document.getElementById('chatHeader');
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = document.getElementById('name').value.trim();
      const age = document.getElementById('age').value.trim();
      const gender = document.getElementById('gender').value.trim();

      if (!name || !age || !gender) return;

      currentUserInfo = { name, age, gender };
      socket.emit('register-user', currentUserInfo);

      loginSection.style.display = 'none';
      chatUI.classList.remove('hidden');
    });

    socket.on('user-list', (userArray) => {
      users = userArray;
      userList.innerHTML = '';
      userArray
        .filter(u => u.name !== currentUserInfo.name)
        .forEach(createUserElement);
    });

    function createUserElement(user) {
      const li = document.createElement('li');
      li.textContent = user.name;
      li.className = 'cursor-pointer p-2 rounded hover:bg-gray-600';
      li.onclick = () => {
        activeUser = user.name;
        chatHeader.textContent = `Chatting with ${user.name}`;
        renderMessages();
      };
      userList.appendChild(li);
    }

    sendBtn.onclick = () => {
      const text = messageInput.value.trim();
      if (!text || !activeUser) return;

      if (!messageStore[activeUser]) messageStore[activeUser] = [];
      messageStore[activeUser].push(`You: ${text}`);
      renderMessages();
      messageInput.value = '';

      const targetUser = users.find(u => u.name === activeUser);
      if (targetUser) {
        socket.emit('private-message', {
          to: targetUser.id,
          message: text
        });
      }
    };

    socket.on('private-message', ({ fromName, message }) => {
      if (!messageStore[fromName]) messageStore[fromName] = [];
      messageStore[fromName].push(`${fromName}: ${message}`);
      if (activeUser === fromName) renderMessages();
    });

    function renderMessages() {
      chatBox.innerHTML = '';
      const messages = messageStore[activeUser] || [];
      messages.forEach(text => {
        const div = document.createElement('div');
        div.className = 'mb-2';
        div.innerText = text;
        chatBox.appendChild(div);
      });
      chatBox.scrollTop = chatBox.scrollHeight;
    }
  </script>
</body>
</html>
